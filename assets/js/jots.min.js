/*! Echo - v0.1.0
 * http://wordpress.org/plugins
 * Copyright (c) 2014; * Licensed GPLv2+ */
(function(t,e){"use strict";function i(){a===e&&(a=new n.controller.Modal),a.open()}function r(){a!==e&&"function"==typeof a.close&&a.close()}var a,n=t.echo=t.echo||{},s=wp.media;_.defaults(n.data||{},{}),n.view={},n.model={},n.controller={},n.controller.Modal=s.view.MediaFrame.extend(function(){function t(){s.view.MediaFrame.prototype.initialize.apply(this,arguments),this.on("all",function(t){console.log(t)}),_.defaults(this.options,{state:"codeLibrary",button:{text:"Insert Jot"}}),this.states.add([new n.controller.State]),this.bindHandlers()}function e(){this.on("router:create:tabs",this.createRouter,this),this.on("router:render:tabs",this.renderRouter,this),this.on("content:create:codeLibrary",this.libraryContent,this),this.on("content:create:codeEdit",this.editContent,this),this.on("toolbar:create:insert",this.createToolbar,this)}function i(t){t.set({codeLibrary:{text:"Jot Library",priority:20},codeEdit:{text:"Edit Jot",priority:40}})}function r(t){t.view=new n.view.Library({controller:this})}function a(t){t.view=new n.view.Edit({controller:this})}function l(t,e){e=e||this.options.button||{},e.controller=this,t.view=new s.view.Toolbar.Select(e)}return{initialize:t,bindHandlers:e,renderRouter:i,libraryContent:r,editContent:a,createToolbar:l}}()),n.controller.State=s.controller.State.extend(function(){function t(){var t=new Backbone.Collection,e=new Backbone.Collection,i=new Backbone.Collection;this.set("cache",t),this.set("library",e),this.set("selection",i)}function i(t){_.isArray(t)||(t=[t]),_.each(t,r,this)}function r(t){t.on("filter",this.applyFilters,this),this.filters[t.param]?t.val([this.filters[t.param]]):t.value!==e&&(this.filters[t.param]=t.value)}function a(t){_.isArray(t)||(t=[t]),_.each(t,n,this)}function n(t){this.filters[t]&&(t.off("filter",this.applyFilters,this),delete this.filters[t.param])}function s(t){this.filters[t.param]!==t.value&&(t.value===e?delete this.filters[t.param]:this.filters[t.param]=t.value,console.log(this.filters))}return{defaults:{id:"codeLibrary",toolbar:"insert",router:"tabs",sidebar:"settings",content:"codeLibrary",menu:"default",title:"Code Jots",select:!0},filters:{},initialize:t,addFilter:i,removeFilter:a,applyFilters:s}}()),n.view.filter=s.View.extend(function(){function i(t){var i,r;_.defaults(t||{},{id:t.id||_.uniqueId("echo"),tagName:"input",className:"echoFilter",attributes:{type:"text"},param:"s",events:{},filterEvents:["change","keyup"],preventDefault:!1}),r=t.template?"."+t.template:!1,this._inputEl=new s.View(t),this.inputId=t.id,_.bindAll(this,"preFilter","filter"),this.filterEvents=t.filterEvents,t.tagName=t._tagName,delete t._tagName,t.className=t._className,delete t._className,t.attributes=t._attributes,delete t._attributes,t.id=t._id,delete t._id;for(i in t)t[i]===e&&delete t[i];s.View.prototype.constructor.call(this,t),r?this.views.add(r,this._inputEl,{add:!1}):this.views.add(this._inputEl,{add:!1}),this.on("prepare",c,this)}function r(t){this.title=t.title,this.param=t.param,this.value=t.value,this.preventDefault=!!t.preventDefault,this.throttle=parseInt(t.throttle,10),(_.isNaN(this.throttle)||0===this.throttle)&&(this.throttle=!1),_.isString(t.template)&&(this.template=wp.template(t.template))}function a(){s.View.prototype.delegateEvents.apply(this,arguments),_.each(this.filterEvents,n,this),this._inputEl.delegateEvents()}function n(t){this._inputEl.events[t]=this.preFilter}function l(e){this.preventDefault&&e.preventDefault(),this.throttle?(t.clearTimeout(this.timeout),this.timeout=t.setTimeout(this.filter,this.throttle)):this.filter()}function o(){var t=this._inputEl.$el.val();this.value=""===t?e:t,this.trigger("filter",this)}function h(t){this._inputEl.$el.val(t)}function c(t){t.inputId=this.inputId}return{filterEvents:{},constructor:i,initialize:r,delegateEvents:a,filter:o,preFilter:l,val:h}}()),n.view.filterTax=n.view.filter.extend(function(){function t(t){n.view.filter.prototype.initialize.apply(this,arguments),this._value=_.defaults(t.value||{},{taxonomy:t.taxonomy,field:t.field,term:e}),this.on("prepare",this.rawValue,this)}function i(t){this.preventDefault&&t.preventDefault();var i=this._inputEl.$el.val();this._value.term=""===i?e:i,this.value=_.isUndefined(this._value.term)?e:this._value,this.trigger("filter",this)}return{initialize:t,filter:i}}()),n.view.Edit=s.View.extend(function(){function t(){this.createSidebar()}function e(){var t=this.options;t.selection,this.sidebar=new s.view.Sidebar({controller:this.controller}),this.views.add(this.sidebar)}return{tagName:"div",className:"jot-editor",initialize:t,createSidebar:e}}()),n.view.Library=s.View.extend(function(){function t(){this.createSidebar(),this.createToolbar()}function e(){var t,e=this.options,i=(e.selection,this.sidebar=new s.view.Sidebar({controller:this.controller}));this.views.add(i),t=new n.view.filterTax({tagName:"select",className:"jot-category",id:"jot-category",title:"Categories"}),i.views.add(t),this.controller.state().addFilter(t)}function i(){var t;this.toolbar=new s.view.Toolbar({controller:this.controller}),this.views.add(this.toolbar),t=new n.view.filter({tagName:"input",className:"jot-search",id:"jot-search",template:"echo-textfield",title:"Search",throttle:300}),this.toolbar.views.add(t),this.controller.state().addFilter(t)}return{tagName:"div",className:"jot-library",initialize:t,createSidebar:e,createToolbar:i}}()),n.open=i,n.close=r})(this);