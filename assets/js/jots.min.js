/*! Echo - v0.1.0
 * http://wordpress.org/plugins
 * Copyright (c) 2014; * Licensed GPLv2+ */
(function(t,e){"use strict";function i(){n===e&&(n=new s.controller.Modal),n.open()}function r(){n!==e&&"function"==typeof n.close&&n.close()}var n,s=t.echo=t.echo||{},a=wp.media;_.defaults(s.data||{},{}),s.view={},s.model={},s.controller={},s.controller.Modal=a.view.MediaFrame.extend(function(){function t(){a.view.MediaFrame.prototype.initialize.apply(this,arguments),this.on("all",function(t){console.log(t)}),_.defaults(this.options,{state:"codeLibrary",button:{text:"Insert Jot"}}),this.states.add([new s.controller.State]),this.bindHandlers()}function e(){this.on("router:create:tabs",this.createRouter,this),this.on("router:render:tabs",this.renderRouter,this),this.on("content:create:codeLibrary",this.libraryContent,this),this.on("content:create:codeEdit",this.editContent,this),this.on("toolbar:create:insert",this.createToolbar,this)}function i(t){t.set({codeLibrary:{text:"Jot Library",priority:20},codeEdit:{text:"Edit Jot",priority:40}})}function r(t){t.view=new s.view.Library({controller:this})}function n(t){t.view=new s.view.Edit({controller:this})}function o(t,e){e=e||this.options.button||{},e.controller=this,t.view=new a.view.Toolbar.Select(e)}return{initialize:t,bindHandlers:e,renderRouter:i,libraryContent:r,editContent:n,createToolbar:o}}()),s.controller.State=a.controller.State.extend(function(){function t(){var t=new Backbone.Collection,e=new Backbone.Collection,i=new Backbone.Collection;this.set("cache",t),this.set("library",e),this.set("selection",i)}function i(t){_.isArray(t)||(t=[t]),_.each(t,r,this)}function r(t){t.on("filter",this.applyFilters,this),this.filters[t.param]=t.value}function n(t){_.isArray(t)||(t=[t]),_.each(t,s,this)}function s(t){this.filters[t]&&(t.off("filter",this.applyFilters,this),delete this.filters[t.param])}function a(t){this.filters[t.param]!==t.value&&(t.value===e?delete this.filters[t.param]:this.filters[t.param]=t.value,console.log(this.filters))}return{defaults:{id:"codeLibrary",toolbar:"insert",router:"tabs",sidebar:"settings",content:"codeLibrary",menu:"default",title:"Code Jots",select:!0},filters:{},initialize:t,addFilter:i,removeFilter:n,applyFilters:a}}()),s.view.filter=a.View.extend(function(){function i(t){var i;_.defaults(t||{},{tagName:"input",className:"echoFilter",attributes:{type:"text"},param:"s",events:{},filterEvents:["change","keyup"],preventDefault:!1}),this._inputEl=new a.View(t),_.bindAll(this,"preFilter","filter"),this.filterEvents=t.filterEvents,t.tagName=t._tagName,delete t._tagName,t.className=t._className,delete t._className,t.attributes=t._attributes,delete t._attributes,t.id=t._id,delete t._id;for(i in t)t[i]===e&&delete t[i];a.View.prototype.constructor.call(this,t),this.views.add(this._inputEl)}function r(t){this.param=t.param,this.value=t.value,this.preventDefault=!!t.preventDefault,this.throttle=parseInt(t.throttle,10),(_.isNaN(this.throttle)||0===this.throttle)&&(this.throttle=!1)}function n(){a.View.prototype.delegateEvents.apply(this,arguments),_.each(this.filterEvents,s,this),this._inputEl.delegateEvents()}function s(t){this._inputEl.events[t]=this.preFilter}function o(e){this.preventDefault&&e.preventDefault(),this.throttle?(t.clearTimeout(this.timeout),this.timeout=t.setTimeout(this.filter,this.throttle)):this.filter()}function l(){var t=this._inputEl.$el.val();this.value=""===t?e:t,this.trigger("filter",this)}return{filterEvents:{},constructor:i,initialize:r,delegateEvents:n,filter:l,preFilter:o}}()),s.view.filterTax=s.view.filter.extend(function(){function t(t){s.view.filter.prototype.initialize.apply(this,arguments),this._value=_.defaults(t.value||{},{taxonomy:t.taxonomy,field:t.field,term:e}),this.on("prepare",this.rawValue,this)}function i(t){this.preventDefault&&t.preventDefault();var i=this._inputEl.$el.val();this._value.term=""===i?e:i,this.value=_.isUndefined(this._value.term)?e:this._value,this.trigger("filter",this)}return{initialize:t,filter:i}}()),s.view.Edit=a.View.extend(function(){function t(){this.createSidebar()}function e(){var t=this.options;t.selection,this.sidebar=new a.view.Sidebar({controller:this.controller}),this.views.add(this.sidebar)}return{tagName:"div",className:"jot-editor",initialize:t,createSidebar:e}}()),s.view.Library=a.View.extend(function(){function t(){this.createSidebar(),this.createToolbar()}function e(){var t=this.options,e=(t.selection,this.sidebar=new a.view.Sidebar({controller:this.controller}));this.views.add(e)}function i(){var t;this.toolbar=new a.view.Toolbar({controller:this.controller}),this.views.add(this.toolbar),t=new s.view.filter({tagName:"input",className:"jot-search",id:"jot-search",throttle:300}),this.toolbar.views.add(t),this.controller.state().addFilter(t)}return{tagName:"div",className:"jot-library",initialize:t,createSidebar:e,createToolbar:i}}()),s.open=i,s.close=r})(this);